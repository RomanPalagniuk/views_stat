# views_stat
Невеликий Koajs API для збору статистики
  В підході до вирішення задачі для побудови сервісу збору й зберігання статистики бралося до уваги потенційно велике навантаження. Нам потрібна швидка пам'ять - тому Redis з його атомарною операцією INCR мабуть краще рішення. Для того щоб передбачити якісь можливі збої в роботі Redis чи перевантаження - додатково використано менеджер черг RabbitMQ та worker-и для обробки подій. Апі має два контроллери track та stats. Перший реагує на івент що відбувся та передає його в чергу із вказівкою типу "eventType": "phone_view" при перегляді номеру телефону, чи "eventType": "ad_view" при перегляді лістингу авто. Другий повертає дані статистики за допомогою сервісу Redis. За допомогою квері-параметрів є можливість отримувати окремо значення переглядів оголошення та переглядів телефону. Базовий запит поверне обидва значення.(приклади запитів будуть нижче в гайді)

  Додатково створений воркер для запуску синхронізованого процесу збереження статистики в базу даних Postgres. Для наглядності прикладу синхронізаційний інтервал для крон-джоби встановлено на 2хв. Результати можна глянути в браузер-інтерфейсі PgAdmin відкривши його на http://localhost:5050 та використати для логіну admin@admin.com і пароль "admin". Далі додати новий сервер з параметрами: Host: postgres, User: postgres, Password: postgres, Database: auto_stats. Таблиця генерується призапуску сервісу з допомогою Docker.

  Серед можливих покращень: отримання статистики з бази Postgres(зараз тільки з Redis), покриття тестами, використання Тайпскрипт, логування та краща обробка помилок.
## Налаштування

### 1. Клонування репозиторію
```sh
git clone https://github.com/RomanPalagniuk/views_stat.git
cd views_stat
```

### 2. Встановлення залежностей
```sh
npm install
```

### 3. Налаштування змінних середовища

Створіть файл `.env` у корені проєкту (опціонально, але рекомендовано):

```
REDIS_URL=redis://redis:6379
RABBITMQ_URL=amqp://stats:securepass@rabbitmq:5672
PG_URL=postgres://auto_stats:yourpassword@postgres:5432/auto_stats
PORT=3000
SYNC_INTERVAL=*/2 * * * *
```

Переконайтеся, що ці значення співпадають із вашими у `docker-compose.yml`.

### 4. Збірка та запуск стеку

```sh
docker-compose up --build
```

Ця команда запустить всі сервіси: API, worker-и, Redis, RabbitMQ, pgAdmin та PostgreSQL.

### 5. Тестування API

- **Відправити подію:**
  ```
  POST http://localhost:3000/track
  Content-Type: application/json

  {
    "autoId": 123,
    "eventType": "ad_view"
  }
  ```
- **Отримати статистику:**
  ```
  GET http://localhost:3000/stats/123
  ```

- **Отримати тільки перегляди оголошення:**  
  ```
  GET http://localhost:3000/stats/123?metrics=ad_views
  ```

- **Отримати тільки перегляди номера телефону:**
  ```
  GET http://localhost:3000/stats/123?metrics=phone_views
  ```

### 6. Перевірка коду лінтером (опціонально)

```sh
npx eslint src/
```

---

## Щоб скинути всі дані, виконайте:
  ```sh
  docker-compose down -v
  ```

---

## Ліцензія
MIT